<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Individual Tree Detection &amp; Segmentation â€“ lidRtutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon/apple-touch-icon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f6095d34f10616eac6186c0f8cd784e8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../assets/custom.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">lidRtutorial</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../01_intro.html"> 
<span class="menu-text">1-INTRO</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../02_read.html"> 
<span class="menu-text">2-LAS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_classification.html"> 
<span class="menu-text">3-CLASSIFICATION</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../04_dtm.html"> 
<span class="menu-text">4-DTM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../05_chm.html"> 
<span class="menu-text">5-CHM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../06_metrics.html"> 
<span class="menu-text">6-METRICS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../07_engine.html"> 
<span class="menu-text">7-LASCATALOG</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../08_solutions.html"> 
<span class="menu-text">8-SOLUTIONS</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-supplemental" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">SUPPLEMENTAL</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-supplemental">    
        <li>
    <a class="dropdown-item" href="../supplemental/S1_roi.html">
 <span class="dropdown-text">ROI</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../supplemental/S2_aba.html">
 <span class="dropdown-text">ABA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../supplemental/S3_its.html">
 <span class="dropdown-text">ITS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../supplemental/S4_engine2.html">
 <span class="dropdown-text">ENGINE</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#relevant-resources" id="toc-relevant-resources" class="nav-link active" data-scroll-target="#relevant-resources">Relevant resources</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#environment" id="toc-environment" class="nav-link" data-scroll-target="#environment">Environment</a></li>
  <li><a href="#chm-based-methods" id="toc-chm-based-methods" class="nav-link" data-scroll-target="#chm-based-methods">CHM based methods</a></li>
  <li><a href="#optionally-smooth-the-chm" id="toc-optionally-smooth-the-chm" class="nav-link" data-scroll-target="#optionally-smooth-the-chm">Optionally smooth the CHM</a></li>
  <li><a href="#tree-detection" id="toc-tree-detection" class="nav-link" data-scroll-target="#tree-detection">Tree detection</a></li>
  <li><a href="#segmentation" id="toc-segmentation" class="nav-link" data-scroll-target="#segmentation">Segmentation</a></li>
  <li><a href="#working-with-rasters" id="toc-working-with-rasters" class="nav-link" data-scroll-target="#working-with-rasters">Working with rasters</a></li>
  <li><a href="#point-cloud-based-methods-no-chm" id="toc-point-cloud-based-methods-no-chm" class="nav-link" data-scroll-target="#point-cloud-based-methods-no-chm">Point-cloud based methods (no CHM)</a>
  <ul>
  <li><a href="#tree-detection-1" id="toc-tree-detection-1" class="nav-link" data-scroll-target="#tree-detection-1">Tree detection</a></li>
  <li><a href="#tree-segmentation" id="toc-tree-segmentation" class="nav-link" data-scroll-target="#tree-segmentation">Tree segmentation</a></li>
  </ul></li>
  <li><a href="#extraction-of-metrics" id="toc-extraction-of-metrics" class="nav-link" data-scroll-target="#extraction-of-metrics">Extraction of metrics</a>
  <ul>
  <li><a href="#using-crown_metrics" id="toc-using-crown_metrics" class="nav-link" data-scroll-target="#using-crown_metrics">Using <code>crown_metrics()</code></a></li>
  <li><a href="#applying-user-defined-functions" id="toc-applying-user-defined-functions" class="nav-link" data-scroll-target="#applying-user-defined-functions">Applying user-defined functions</a></li>
  <li><a href="#using-pre-defined-metrics" id="toc-using-pre-defined-metrics" class="nav-link" data-scroll-target="#using-pre-defined-metrics">Using pre-defined metrics</a></li>
  <li><a href="#delineating-crowns" id="toc-delineating-crowns" class="nav-link" data-scroll-target="#delineating-crowns">Delineating crowns</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul></li>
  <li><a href="#using" id="toc-using" class="nav-link" data-scroll-target="#using">Using:</a>
  <ul>
  <li><a href="#e1." id="toc-e1." class="nav-link" data-scroll-target="#e1.">E1.</a></li>
  <li><a href="#e2." id="toc-e2." class="nav-link" data-scroll-target="#e2.">E2.</a></li>
  <li><a href="#e3." id="toc-e3." class="nav-link" data-scroll-target="#e3.">E3.</a></li>
  <li><a href="#e4." id="toc-e4." class="nav-link" data-scroll-target="#e4.">E4.</a></li>
  <li><a href="#e5." id="toc-e5." class="nav-link" data-scroll-target="#e5.">E5.</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Individual Tree Detection &amp; Segmentation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="relevant-resources" class="level2">
<h2 class="anchored" data-anchor-id="relevant-resources">Relevant resources</h2>
<ul>
<li><a href="https://github.com/tgoodbody/lidRtutorial/blob/master/R/06_its.R">Code</a></li>
<li><a href="https://r-lidar.github.io/lidRbook/itd-its.html">lidRbook section</a></li>
</ul>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This code demonstrates individual tree segmentation (ITS) using LiDAR data. It covers CHM-based and point cloud-based methods for tree detection and segmentation. The code also shows how to extract metrics at the tree level and visualize them.</p>
</section>
<section id="environment" class="level2">
<h2 class="anchored" data-anchor-id="environment">Environment</h2>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear environment</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="fu">globalenv</span>()))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lidR)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in LiDAR file and set some color palettes</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(<span class="st">"data/MixedEucaNat_normalized.laz"</span>,  <span class="at">filter =</span> <span class="st">"-set_withheld_flag 0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">height.colors</span>(<span class="dv">50</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>col1 <span class="ot">&lt;-</span> <span class="fu">pastel.colors</span>(<span class="dv">900</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chm-based-methods" class="level2">
<h2 class="anchored" data-anchor-id="chm-based-methods">CHM based methods</h2>
<p>We start by creating a Canopy Height Model (CHM) from the LiDAR data. The <code>rasterize_canopy()</code> function generates the CHM using a specified resolution (<code>res</code>) and a chosen algorithm, here <code>p2r(0.15)</code>, to compute the percentiles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate CHM</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>chm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(<span class="at">las =</span> las, <span class="at">res =</span> <span class="fl">0.5</span>, <span class="at">algorithm =</span> <span class="fu">p2r</span>(<span class="fl">0.15</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/chm_creation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After building the CHM, we visualize it using a color palette (<code>col</code>).</p>
</section>
<section id="optionally-smooth-the-chm" class="level2">
<h2 class="anchored" data-anchor-id="optionally-smooth-the-chm">Optionally smooth the CHM</h2>
<p>Optionally, we can smooth the CHM using a kernel to remove small-scale variations and enhance larger features like tree canopies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate kernel and smooth chm</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>kernel <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>schm <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">x =</span> chm, <span class="at">w =</span> kernel, <span class="at">fun =</span> median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(schm, <span class="at">col =</span> col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/chm_smoothing-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, we smooth the CHM using a median filter with a 3x3 kernel. The smoothed CHM (<code>schm</code>) is visualized using a color palette to represent height values.</p>
</section>
<section id="tree-detection" class="level2">
<h2 class="anchored" data-anchor-id="tree-detection">Tree detection</h2>
<p>Next, we detect tree tops using the smoothed CHM. The <code>locate_trees()</code> function identifies tree tops based on local maxima.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect trees</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ttops <span class="ot">&lt;-</span> <span class="fu">locate_trees</span>(<span class="at">las =</span> schm, <span class="at">algorithm =</span> <span class="fu">lmf</span>(<span class="at">ws =</span> <span class="fl">2.5</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>ttops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 935 features and 2 fields
Attribute-geometry relationships: constant (2)
Geometry type: POINT
Dimension:     XYZ
Bounding box:  xmin: 203830.2 ymin: 7358900 xmax: 203979.8 ymax: 7359050
Projected CRS: SIRGAS 2000 / UTM zone 23S
First 10 features:
   treeID      Z                       geometry
1       1  5.230 POINT Z (203878.8 7359050 5...
2       2  3.900 POINT Z (203889.8 7359050 3.9)
3       3  7.360 POINT Z (203898.8 7359050 7...
4       4 17.790 POINT Z (203905.8 7359050 1...
5       5 11.940 POINT Z (203935.8 7359050 1...
6       6  3.275 POINT Z (203939.2 7359050 3...
7       7 21.550 POINT Z (203951.8 7359050 2...
8       8 17.290 POINT Z (203963.8 7359050 1...
9       9 21.085 POINT Z (203977.2 7359050 2...
10     10 19.220 POINT Z (203914.8 7359049 1...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> col)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ttops, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/tree_detection-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The detected tree tops (<code>ttops</code>) are plotted on top of the CHM (<code>chm</code>) to visualize their positions.</p>
</section>
<section id="segmentation" class="level2">
<h2 class="anchored" data-anchor-id="segmentation">Segmentation</h2>
<p>Now, we perform tree segmentation using the detected tree tops. The <code>segment_trees()</code> function segments the trees in the LiDAR point cloud based on the previously detected tree tops.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Segment trees using dalponte</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">segment_trees</span>(<span class="at">las =</span> las, <span class="at">algorithm =</span> <span class="fu">dalponte2016</span>(<span class="at">chm =</span> schm, <span class="at">treetops =</span> ttops))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count number of trees detected and segmented</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(las<span class="sc">$</span>treeID) <span class="sc">|&gt;</span> <span class="fu">na.omit</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 935</code></pre>
</div>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize all trees</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(las, <span class="at">color =</span> <span class="st">"treeID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select trees by ID</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tree25 <span class="ot">&lt;-</span> <span class="fu">filter_poi</span>(<span class="at">las =</span> las, treeID <span class="sc">==</span> <span class="dv">25</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>tree125 <span class="ot">&lt;-</span> <span class="fu">filter_poi</span>(<span class="at">las =</span> las, treeID <span class="sc">==</span> <span class="dv">125</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree25, <span class="at">size =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>plot(tree125, size = 3)</code></pre>
<p>After segmentation, we count the number of trees detected and visualize all the trees in the point cloud. We then select two trees (<code>tree25</code> and <code>tree125</code>) and visualize them individually.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Variability and testing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Forests are <strong>highly</strong> variable! This means that some algorithms and parameters will work better than others depending on the data you have. Play around with algorithms and see which works best for your data.</p>
</div>
</div>
</section>
<section id="working-with-rasters" class="level2">
<h2 class="anchored" data-anchor-id="working-with-rasters">Working with rasters</h2>
<p>The <code>lidR</code> package is designed for point clouds, but some functions can be applied to raster data as well. Here, we show how to extract trees from the CHM without using the point cloud directly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate rasterized delineation</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>trees <span class="ot">&lt;-</span> <span class="fu">dalponte2016</span>(<span class="at">chm =</span> chm, <span class="at">treetops =</span> ttops)() <span class="co"># Notice the parenthesis at the end</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>trees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
size        : 300, 300, 1  (nrow, ncol, nlyr)
resolution  : 0.5, 0.5  (x, y)
extent      : 203830, 203980, 7358900, 7359050  (xmin, xmax, ymin, ymax)
coord. ref. : SIRGAS 2000 / UTM zone 23S (EPSG:31983) 
source(s)   : memory
name        :   Z 
min value   :   1 
max value   : 935 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(trees, <span class="at">col =</span> col1)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ttops, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.sf(ttops, add = TRUE, cex = 0.5): ignoring all but the first
attribute</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/raster_trees-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We create tree objects (<code>trees</code>) using the <code>dalponte2016</code> algorithm with the CHM and tree tops. The resulting objects are visualized alongside the detected tree tops.</p>
</section>
<section id="point-cloud-based-methods-no-chm" class="level1">
<h1>Point-cloud based methods (no CHM)</h1>
<p>In this section, we will explore tree detection and segmentation methods that do not require a CHM.</p>
<section id="tree-detection-1" class="level2">
<h2 class="anchored" data-anchor-id="tree-detection-1">Tree detection</h2>
<p>We begin with tree detection using the local maxima filtering (lmf) algorithm. This approach directly works with the LiDAR point cloud to detect tree tops.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect trees</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ttops <span class="ot">&lt;-</span> <span class="fu">locate_trees</span>(<span class="at">las =</span> las, <span class="at">algorithm =</span> <span class="fu">lmf</span>(<span class="at">ws =</span> <span class="dv">3</span>, <span class="at">hmin =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">plot</span>(las)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">add_treetops3d</span>(<span class="at">x =</span> x, <span class="at">ttops =</span> ttops, <span class="at">radius =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We detect tree tops using the <code>lmf</code> algorithm and visualize them in 3D by adding the tree tops to the LiDAR plot.</p>
</section>
<section id="tree-segmentation" class="level2">
<h2 class="anchored" data-anchor-id="tree-segmentation">Tree segmentation</h2>
<p>Next, we perform tree segmentation using the <code>li2012</code> algorithm, which directly processes the LiDAR point cloud.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Segment using li</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">segment_trees</span>(<span class="at">las =</span> las, <span class="at">algorithm =</span> <span class="fu">li2012</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Tree segmentation: 3% (1 threads)
Tree segmentation: 4% (1 threads)
Tree segmentation: 5% (1 threads)
Tree segmentation: 6% (1 threads)
Tree segmentation: 7% (1 threads)
Tree segmentation: 8% (1 threads)
Tree segmentation: 9% (1 threads)
Tree segmentation: 10% (1 threads)
Tree segmentation: 11% (1 threads)
Tree segmentation: 12% (1 threads)
Tree segmentation: 13% (1 threads)
Tree segmentation: 14% (1 threads)
Tree segmentation: 15% (1 threads)
Tree segmentation: 16% (1 threads)
Tree segmentation: 17% (1 threads)
Tree segmentation: 18% (1 threads)
Tree segmentation: 19% (1 threads)
Tree segmentation: 20% (1 threads)
Tree segmentation: 21% (1 threads)
Tree segmentation: 22% (1 threads)
Tree segmentation: 23% (1 threads)
Tree segmentation: 24% (1 threads)
Tree segmentation: 25% (1 threads)
Tree segmentation: 26% (1 threads)
Tree segmentation: 27% (1 threads)
Tree segmentation: 28% (1 threads)
Tree segmentation: 29% (1 threads)
Tree segmentation: 30% (1 threads)
Tree segmentation: 31% (1 threads)
Tree segmentation: 32% (1 threads)
Tree segmentation: 33% (1 threads)
Tree segmentation: 34% (1 threads)
Tree segmentation: 35% (1 threads)
Tree segmentation: 36% (1 threads)
Tree segmentation: 37% (1 threads)
Tree segmentation: 38% (1 threads)
Tree segmentation: 39% (1 threads)
Tree segmentation: 40% (1 threads)
Tree segmentation: 41% (1 threads)
Tree segmentation: 42% (1 threads)
Tree segmentation: 43% (1 threads)
Tree segmentation: 44% (1 threads)
Tree segmentation: 45% (1 threads)
Tree segmentation: 46% (1 threads)
Tree segmentation: 47% (1 threads)
Tree segmentation: 48% (1 threads)
Tree segmentation: 49% (1 threads)
Tree segmentation: 50% (1 threads)
Tree segmentation: 51% (1 threads)
Tree segmentation: 52% (1 threads)
Tree segmentation: 53% (1 threads)
Tree segmentation: 54% (1 threads)
Tree segmentation: 55% (1 threads)
Tree segmentation: 56% (1 threads)
Tree segmentation: 57% (1 threads)
Tree segmentation: 58% (1 threads)
Tree segmentation: 59% (1 threads)
Tree segmentation: 60% (1 threads)
Tree segmentation: 61% (1 threads)
Tree segmentation: 62% (1 threads)
Tree segmentation: 63% (1 threads)
Tree segmentation: 64% (1 threads)
Tree segmentation: 65% (1 threads)
Tree segmentation: 66% (1 threads)
Tree segmentation: 67% (1 threads)
Tree segmentation: 68% (1 threads)
Tree segmentation: 69% (1 threads)
Tree segmentation: 70% (1 threads)
Tree segmentation: 71% (1 threads)
Tree segmentation: 72% (1 threads)
Tree segmentation: 73% (1 threads)
Tree segmentation: 74% (1 threads)
Tree segmentation: 75% (1 threads)
Tree segmentation: 76% (1 threads)
Tree segmentation: 77% (1 threads)
Tree segmentation: 78% (1 threads)
Tree segmentation: 79% (1 threads)
Tree segmentation: 80% (1 threads)
Tree segmentation: 81% (1 threads)
Tree segmentation: 82% (1 threads)
Tree segmentation: 83% (1 threads)
Tree segmentation: 84% (1 threads)
Tree segmentation: 85% (1 threads)
Tree segmentation: 86% (1 threads)
Tree segmentation: 87% (1 threads)
Tree segmentation: 88% (1 threads)
Tree segmentation: 89% (1 threads)
Tree segmentation: 100% (1 threads)</code></pre>
</div>
</div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(las, <span class="at">color =</span> <span class="st">"treeID"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This algorithm does not seem pertinent for this dataset.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>li2012</code> algorithm segments the trees in the LiDAR point cloud based on local neighborhood information. However, it may not be optimal for this specific dataset.</p>
</section>
</section>
<section id="extraction-of-metrics" class="level1">
<h1>Extraction of metrics</h1>
<p>We will extract various metrics from the tree segmentation results.</p>
<section id="using-crown_metrics" class="level2">
<h2 class="anchored" data-anchor-id="using-crown_metrics">Using <code>crown_metrics()</code></h2>
<p>The <code>crown_metrics()</code> function extracts metrics from the segmented trees using a user-defined function. We use the length of the Z coordinate to obtain the tree height as an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate metrics for each delineated crown</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">crown_metrics</span>(<span class="at">las =</span> las, <span class="at">func =</span> <span class="sc">~</span><span class="fu">list</span>(<span class="at">n =</span> <span class="fu">length</span>(Z)))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 752 features and 2 fields
Geometry type: POINT
Dimension:     XYZ
Bounding box:  xmin: 203830 ymin: 7358900 xmax: 203980 ymax: 7359050
z_range:       zmin: 2.02 zmax: 34.46
Projected CRS: SIRGAS 2000 / UTM zone 23S
First 10 features:
   treeID    n                       geometry
1       1 2774 POINT Z (203969.4 7359045 3...
2       2 1918 POINT Z (203969.5 7358922 3...
3       3  859 POINT Z (203967.8 7358926 3...
4       4 1605 POINT Z (203943.1 7358936 3...
5       5  454 POINT Z (203954.5 7358949 3...
6       6  417 POINT Z (203957.8 7358949 3...
7       7  946 POINT Z (203949.7 7358943 3...
8       8 1671 POINT Z (203970 7358900 32.09)
9       9 1106 POINT Z (203975.2 7358915 3...
10     10  411 POINT Z (203947.7 7358949 3...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(metrics[<span class="st">"n"</span>], <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/crown_metrics_example-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We calculate the number of points (<code>n</code>) in each tree crown using a user-defined function, and then visualize the results.</p>
</section>
<section id="applying-user-defined-functions" class="level2">
<h2 class="anchored" data-anchor-id="applying-user-defined-functions">Applying user-defined functions</h2>
<p>We can map any user-defined function at the tree level using the <code>crown_metrics()</code> function, just like <code>pixel_metrics()</code>. Here, we calculate the convex hull area of each tree using a custom function <code>f()</code> and then visualize the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># User defined function for area calculation</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get xy for tree</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, y)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convex hull</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  ch <span class="ot">&lt;-</span> <span class="fu">chull</span>(coords)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Close coordinates</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  ch <span class="ot">&lt;-</span> <span class="fu">c</span>(ch, ch[<span class="dv">1</span>])</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  ch_coords <span class="ot">&lt;-</span> coords[ch, ]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate polygon</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_polygon</span>(<span class="fu">list</span>(ch_coords))</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate area</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  area <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_area</span>(p)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">A =</span> area))</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply user-defined function</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">crown_metrics</span>(<span class="at">las =</span> las, <span class="at">func =</span> <span class="sc">~</span><span class="fu">f</span>(X, Y))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 752 features and 2 fields
Geometry type: POINT
Dimension:     XYZ
Bounding box:  xmin: 203830 ymin: 7358900 xmax: 203980 ymax: 7359050
z_range:       zmin: 2.02 zmax: 34.46
Projected CRS: SIRGAS 2000 / UTM zone 23S
First 10 features:
   treeID         A                       geometry
1       1 172.51720 POINT Z (203969.4 7359045 3...
2       2 103.84100 POINT Z (203969.5 7358922 3...
3       3  72.18270 POINT Z (203967.8 7358926 3...
4       4  79.85055 POINT Z (203943.1 7358936 3...
5       5  17.34630 POINT Z (203954.5 7358949 3...
6       6  17.45860 POINT Z (203957.8 7358949 3...
7       7  41.13120 POINT Z (203949.7 7358943 3...
8       8  71.97225 POINT Z (203970 7358900 32.09)
9       9  50.51530 POINT Z (203975.2 7358915 3...
10     10  24.61015 POINT Z (203947.7 7358949 3...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(metrics[<span class="st">"A"</span>], <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/user_defined_metrics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
3rd party metric packages
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember that you can use 3rd party packages like <a href="https://github.com/ptompalski/lidRmetrics"><code>lidRmetrics</code></a> for crown metrics too!</p>
</div>
</div>
</section>
<section id="using-pre-defined-metrics" class="level2">
<h2 class="anchored" data-anchor-id="using-pre-defined-metrics">Using pre-defined metrics</h2>
<p>Some metrics are already recorded, and we can directly calculate them at the tree level using <code>crown_metrics()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">crown_metrics</span>(<span class="at">las =</span> las, <span class="at">func =</span> .stdtreemetrics)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 752 features and 4 fields
Geometry type: POINT
Dimension:     XYZ
Bounding box:  xmin: 203830 ymin: 7358900 xmax: 203980 ymax: 7359050
z_range:       zmin: 2.02 zmax: 34.46
Projected CRS: SIRGAS 2000 / UTM zone 23S
First 10 features:
   treeID     Z npoints convhull_area                       geometry
1       1 34.46    2774       172.517 POINT Z (203969.4 7359045 3...
2       2 32.52    1918       103.841 POINT Z (203969.5 7358922 3...
3       3 32.46     859        72.183 POINT Z (203967.8 7358926 3...
4       4 32.35    1605        79.851 POINT Z (203943.1 7358936 3...
5       5 32.33     454        17.346 POINT Z (203954.5 7358949 3...
6       6 32.22     417        17.459 POINT Z (203957.8 7358949 3...
7       7 32.14     946        41.131 POINT Z (203949.7 7358943 3...
8       8 32.09    1671        71.972 POINT Z (203970 7358900 32.09)
9       9 32.08    1106        50.515 POINT Z (203975.2 7358915 3...
10     10 32.01     411        24.610 POINT Z (203947.7 7358949 3...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize individual metrics</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> metrics[<span class="st">"convhull_area"</span>], <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/pre_defined_metrics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> metrics[<span class="st">"Z"</span>], <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/pre_defined_metrics-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We calculate tree-level metrics using <code>.stdtreemetrics</code> and visualize individual metrics like convex hull area and height.</p>
</section>
<section id="delineating-crowns" class="level2">
<h2 class="anchored" data-anchor-id="delineating-crowns">Delineating crowns</h2>
<p>The <code>crown_metrics()</code> function segments trees and extracts metrics at the crown level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cvx_hulls <span class="ot">&lt;-</span> <span class="fu">crown_metrics</span>(<span class="at">las =</span> las, <span class="at">func =</span> .stdtreemetrics, <span class="at">geom =</span> <span class="st">'convex'</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>cvx_hulls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 752 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 203830 ymin: 7358900 xmax: 203980 ymax: 7359050
Projected CRS: SIRGAS 2000 / UTM zone 23S
First 10 features:
   treeID     Z npoints convhull_area                       geometry
1       1 34.46    2774       172.517 POLYGON ((203977.3 7359044,...
2       2 32.52    1918       103.841 POLYGON ((203963.7 7358914,...
3       3 32.46     859        72.183 POLYGON ((203969.1 7358926,...
4       4 32.35    1605        79.851 POLYGON ((203948 7358933, 2...
5       5 32.33     454        17.346 POLYGON ((203955.8 7358949,...
6       6 32.22     417        17.459 POLYGON ((203959.3 7358948,...
7       7 32.14     946        41.131 POLYGON ((203950.8 7358941,...
8       8 32.09    1671        71.972 POLYGON ((203975.7 7358902,...
9       9 32.08    1106        50.515 POLYGON ((203977 7358915, 2...
10     10 32.01     411        24.610 POLYGON ((203950.3 7358949,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvx_hulls)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ttops, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.sf(ttops, add = TRUE, cex = 0.5): ignoring all but the first
attribute</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/delineate_crowns-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize individual metrics based on values</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> cvx_hulls[<span class="st">"convhull_area"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/delineate_crowns-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> cvx_hulls[<span class="st">"Z"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="S3_its_files/figure-html/delineate_crowns-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We use <code>crown_metrics()</code> with <code>.stdtreemetrics</code> to segment trees and extract metrics based on crown delineation.</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
</section>
</section>
<section id="using" class="level1">
<h1>Using:</h1>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(<span class="at">files =</span> <span class="st">"data/MixedEucaNat_normalized.laz"</span>, <span class="at">filter =</span> <span class="st">"-set_withheld_flag 0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="e1." class="level4">
<h4 class="anchored" data-anchor-id="e1.">E1.</h4>
<p>Find and count the trees.</p>
</section>
<section id="e2." class="level4">
<h4 class="anchored" data-anchor-id="e2.">E2.</h4>
<p>Compute and map the density of trees with a 10 m resolution.</p>
</section>
<section id="e3." class="level4">
<h4 class="anchored" data-anchor-id="e3.">E3.</h4>
<p>Segment the trees.</p>
</section>
<section id="e4." class="level4">
<h4 class="anchored" data-anchor-id="e4.">E4.</h4>
<p>Assuming that the biomass of a tree can be estimated using the crown area and the mean Z of the points with the formula <code>2.5 * area + 3 * mean Z</code>, estimate the biomass of each tree.</p>
</section>
<section id="e5." class="level4">
<h4 class="anchored" data-anchor-id="e5.">E5.</h4>
<p>Map the total biomass at a resolution of 10 m. The output is a mix of ABA and ITS. Hint: use the <code>terra</code> package to rasterize spatial object with the function <code>rasterize()</code>.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This concludes the tutorial on various methods for tree detection, segmentation, and extraction of metrics using the <code>lidR</code> package in R.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/r-lidar\.github\.io\/lidRbook\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>